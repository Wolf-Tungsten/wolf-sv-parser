ROOT := $(abspath ../../../../..)
WOLF_SV_PARSER ?= $(ROOT)/build/bin/wolf-sv-parser
FILELIST := $(CURDIR)/filelist.f
COVERAGE ?= 0
OUT_DIR_BASE := $(ROOT)/build/c910_bug_case/case_CASE_ID
OUT_DIR := $(if $(filter 1,$(COVERAGE)),$(OUT_DIR_BASE)_cov,$(OUT_DIR_BASE))
WOLF_DIR := $(OUT_DIR)/wolf
RTL_DIR := $(OUT_DIR)/rtl
OUT := $(WOLF_DIR)/wolf_emit.sv

DUT_TOP := DUT_TOP
TB_SRC := $(CURDIR)/tb_case_CASE_ID.cpp
VERILATOR ?= verilator
VERILATOR_COVERAGE ?= verilator_coverage
COV_MIN ?= 90
COVERAGE_FLAGS = $(if $(filter 1,$(COVERAGE)),--coverage,)
VERILATOR_FLAGS ?= --no-timing -Wall -Wno-fatal -Wno-DECLFILENAME -Wno-UNUSEDSIGNAL \
	-Wno-UNDRIVEN -Wno-SYNCASYNCNET -Wno-PINCONNECTEMPTY -Wno-ASSIGNDLY -Wno-MULTIDRIVEN
VERILATOR_FLAGS += $(COVERAGE_FLAGS)
SIM_BIN_NAME := sim_case_CASE_ID
RTL_SIM_BIN := $(RTL_DIR)/$(SIM_BIN_NAME)
WOLF_SIM_BIN := $(WOLF_DIR)/$(SIM_BIN_NAME)
VERILATOR_PREFIX := V$(DUT_TOP)
RTL_VERILATOR_MK := $(RTL_DIR)/$(VERILATOR_PREFIX).mk
WOLF_VERILATOR_MK := $(WOLF_DIR)/$(VERILATOR_PREFIX).mk
COV_DATA := $(RTL_DIR)/coverage.dat
COV_INFO := $(RTL_DIR)/coverage.info
WOLF_COV_DATA := $(WOLF_DIR)/coverage.dat
WOLF_COV_INFO := $(WOLF_DIR)/coverage.info
COV_CHECK := $(CURDIR)/coverage_check.py

.PHONY: run run_c910_bug_case_ref run_c910_bug_case clean

run:
	@if [ ! -x "$(WOLF_SV_PARSER)" ]; then \
		echo "[case_CASE_ID] wolf-sv-parser not found: $(WOLF_SV_PARSER)"; \
		echo "[case_CASE_ID] Build it from repo root: cmake -S . -B build && cmake --build build --target wolf-sv-parser"; \
		exit 1; \
	fi
	@mkdir -p $(WOLF_DIR)
	@$(WOLF_SV_PARSER) --emit-sv --emit-json --top $(DUT_TOP) -o $(OUT) -f $(FILELIST)

$(RTL_SIM_BIN): $(TB_SRC) $(FILELIST)
	@if ! command -v $(VERILATOR) >/dev/null 2>&1; then \
		echo "[case_CASE_ID] verilator not found in PATH"; \
		exit 1; \
	fi
	@mkdir -p $(RTL_DIR)
	@$(VERILATOR) $(VERILATOR_FLAGS) --cc -f $(FILELIST) --exe $(TB_SRC) \
		--top-module $(DUT_TOP) -Mdir $(RTL_DIR) -o $(SIM_BIN_NAME)
	CCACHE_DISABLE=1 $(MAKE) -C $(RTL_DIR) -f $(RTL_VERILATOR_MK) $(SIM_BIN_NAME)

$(WOLF_SIM_BIN): $(TB_SRC)
	@if [ ! -x "$(WOLF_SV_PARSER)" ]; then \
		echo "[case_CASE_ID] wolf-sv-parser not found: $(WOLF_SV_PARSER)"; \
		echo "[case_CASE_ID] Build it from repo root: cmake -S . -B build && cmake --build build --target wolf-sv-parser"; \
		exit 1; \
	fi
	@if ! command -v $(VERILATOR) >/dev/null 2>&1; then \
		echo "[case_CASE_ID] verilator not found in PATH"; \
		exit 1; \
	fi
	@mkdir -p $(WOLF_DIR)
	@$(WOLF_SV_PARSER) --emit-sv --emit-json --top $(DUT_TOP) -o $(OUT) -f $(FILELIST)
	@$(VERILATOR) $(VERILATOR_FLAGS) --cc $(OUT) --exe $(TB_SRC) \
		--top-module $(DUT_TOP) -Mdir $(WOLF_DIR) -o $(SIM_BIN_NAME)
	CCACHE_DISABLE=1 $(MAKE) -C $(WOLF_DIR) -f $(WOLF_VERILATOR_MK) $(SIM_BIN_NAME)

run_c910_bug_case_ref: COVERAGE=1
run_c910_bug_case_ref: $(RTL_SIM_BIN)
	@if ! command -v $(VERILATOR_COVERAGE) >/dev/null 2>&1; then \
		echo "[case_CASE_ID] verilator_coverage not found in PATH"; \
		exit 1; \
	fi
	@echo "[RUN] ./$(RTL_SIM_BIN)"
	@cd $(RTL_DIR) && VERILATOR_COV_FILE=$(COV_DATA) ./$(SIM_BIN_NAME)
	@$(VERILATOR_COVERAGE) --write-info $(COV_INFO) $(COV_DATA)
	@python $(COV_CHECK) $(COV_INFO) $(COV_MIN)

run_c910_bug_case: COVERAGE=1
run_c910_bug_case: $(WOLF_SIM_BIN)
	@if ! command -v $(VERILATOR_COVERAGE) >/dev/null 2>&1; then \
		echo "[case_CASE_ID] verilator_coverage not found in PATH"; \
		exit 1; \
	fi
	@echo "[RUN] ./$(WOLF_SIM_BIN)"
	@cd $(WOLF_DIR) && VERILATOR_COV_FILE=$(WOLF_COV_DATA) ./$(SIM_BIN_NAME)
	@$(VERILATOR_COVERAGE) --write-info $(WOLF_COV_INFO) $(WOLF_COV_DATA)
	@python $(COV_CHECK) $(WOLF_COV_INFO) $(COV_MIN)

clean:
	@rm -rf $(OUT_DIR_BASE) $(OUT_DIR_BASE)_cov
