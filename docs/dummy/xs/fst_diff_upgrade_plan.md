# fst_diff 工具升级方案

## 1. 目标
针对当前 `tools/fst_diff_tool.py` 在 RTL 分歧定位中的不足，提升其对“事件计数不一致（例如某类累计计数器差一条）”这类问题的诊断能力：
- 能在**同周期对齐**的前提下比较基准 vs 目标波形
- 能**仅对指定信号集合做 diff**，而不是全局 diff
- 能**对两文件信号做交集**，并基于交集/指定集合进行比较
- 能**输出多处差异**，避免仅报告“第一次差异”被随机初始化淹没
- 支持**可选的事件计数模式**，用于把脉冲型差异聚合成计数结论
- 提供**速度优先模式**，避免全量扫描（允许近似，需用户知情）

## 2. 当前缺陷与改进方向

### 2.1 只能找“最早差异信号”，无法回答“少事件在哪一拍”
- 现状：只输出最早差异，无法统计事件数或找缺失的事件
- 改进：增加“事件计数与对齐模式”，统计用户指定的事件脉冲并标记差异周期

### 2.2 不支持按时钟对齐
- 现状：仅按原始 time tick 比较
- 改进：增加 `--clk` 和 `--cycle-start/--cycle-end`，将事件对齐到周期

### 2.3 随机初始化噪声淹没真实差异
- 现状：t=0 的随机差异占据“最早差异”结果
- 改进：
  - 允许用户显式指定 diff 起始时间 `--t0`（比 reset 信号更通用）
  - 增加 `--skip-initial`（等价于 `--no-initial`）并默认开启
  - 仅对用户指定信号集合做 diff，避免全局随机噪声

### 2.4 缺少“信号交集/指定集合”的工作流
- 现状：未显式暴露“信号交集”概念，容易滑向全局 diff
- 改进：
  - 明确引入“信号交集”步骤：以交集为上限，再应用用户指定的 filter
  - 默认不允许全局 diff；必须提供信号列表/glob/文件，否则报错

### 2.5 无法跨信号做语义聚合
- 现状：不知道哪些 diff 会影响累计计数器
- 改进：提供“事件聚合”功能，直接输出：
  - 事件脉冲的按周期累积
  - 累计类计数器的变化序列

## 3. 具体升级方案

### 3.1 新增“周期对齐”模式
**新增参数：**
- `--clk <signal>`：指定时钟信号
- `--cycle-start/--cycle-end`：按周期限定 ROI
- `--cycle-base {0,1}`：周期编号基准
- `--edge {rising,falling}`：时钟沿

**实现要点：**
- 复用 `tools/fst_roi/fst_roi.py` 里的时钟 ROI 逻辑
- 对比时将 time 转换为 cycle index

### 3.2 新增“事件诊断模式”
**新增参数：**
- `--event-mode`：启用事件诊断
- `--event-signals <glob或list>`：指定事件脉冲路径

**输出：**
- 每周期事件计数
- 累计事件数曲线
- ref/wolf 第一次事件数不一致的周期

### 3.3 新增“累计计数器轨迹对比”
**新增参数：**
- `--counter-signal <signal>`：指定累计计数器信号
- `--dump-counter`：输出计数器随周期变化

**输出：**
- ref 与 wolf 计数器在每周期的值
- 首次出现差值的周期

### 3.4 增强“随机初始化隔离”
**新增参数：**
- `--t0 <time>`：显式指定 diff 起始时间
- `--t1 <time>`：显式指定 diff 结束时间
- `--skip-initial`：默认跳过 t0 前状态

**默认策略：**
- 若提供 `--t0`，则从 t0 开始对比
- 默认 `--skip-initial` 开启

### 3.5 增强“信号交集 + 指定集合”能力
**新增参数：**
- `--signals`/`--signal`/`--signals-file`：明确指定需比较的信号集合
- `--allow-all-signals`：允许在未指定信号集合时比较所有交集信号（默认禁用）

**行为：**
- 先计算 A/B 信号交集
- 在交集上应用用户指定的信号过滤
- 默认禁止全局 diff，避免无意义结果

### 3.6 增强差异输出
**新增参数：**
- `--diff-mode {all,summary,first}`：默认 `summary`，输出多处差异而非仅第一次
- `--max-diffs <N>`：限制输出的差异条数，防止过量

**行为：**
- `summary` 输出每个信号的首次差异周期与差异次数
- `all` 输出全部差异事件（受 `--max-diffs` 限制）
- `first` 仅保留首次差异（保留兼容模式）

### 3.7 增强输出格式
**新增输出：**
- `--format table`：人类可读摘要
- `--format jsonl`：可供脚本进一步处理

### 3.8 增强速度（快速采样）
**新增参数：**
- `--fast`：只在采样点做比较（可显著提速，但可能漏掉采样间的短脉冲）
- `--cache-dir` / `--no-cache`：信号索引缓存，加速重复运行

**行为：**
- 未指定 `--clk`：只比较 `t0/t1` 采样点（近似）
- 指定 `--clk`：在对齐后的时钟沿采样（近似）
- `--fast` 会标记在输出元数据中，提示结果为采样近似
- 缓存仅影响“信号表加载”阶段，不改变 diff 语义

## 4. 最小可行升级（MVP）
为尽快解决“累计计数器不一致”的诊断问题，先实现以下最小集合：
1) `--clk` + cycle 对齐
2) `--event-mode` 统计事件脉冲
3) `--counter-signal` 输出累计计数器轨迹
4) 默认 `--skip-initial` + `--t0` 支持
5) 默认禁止全局 diff（需显式指定信号集合或使用 `--allow-all-signals`）
6) 默认 `--diff-mode summary` 输出多处差异
7) `--fast` 采样模式用于快速定位

## 5. 预期使用示例

```bash
# 统计事件按周期累积，并找出差异周期
python3 tools/fst_diff_tool.py \
  --fst-a <ref.fst> \
  --fst-b <dut.fst> \
  --clk <clk-signal> \
  --t0 <start-time> \
  --event-mode \
  --event-signals '<event-signal-patterns>' \
  --diff-mode summary \
  --fast

# 输出累计计数器曲线对比
python3 tools/fst_diff_tool.py \
  --fst-a <ref.fst> \
  --fst-b <dut.fst> \
  --clk <clk-signal> \
  --t0 <start-time> \
  --counter-signal <counter-signal> \
  --diff-mode summary \
  --fast
```

## 6. 风险与限制
- 需要保证 `pylibfst` 的性能可接受（大波形下可能仍慢）
- 事件/计数相关信号名在不同构建可能变化，需要支持 glob/列表/配置文件输入
- clk 信号名可能需要用户显式提供
- `--fast` 为采样近似，可能漏掉采样间的短脉冲；如需精确差异需关闭 `--fast`

## 7. 后续扩展
- 支持多核对齐（coreid 过滤）
- 增加“自动信号发现”功能：从计数器或上下游信号反推事件路径
