# XS wave diff 20260214_220725

## Executive summary
The earliest divergence between ref and wolf happens at time 0 in SimJTAG and IOPMP table signals. The wolf emit drops initialization for `random_bits` in SimJTAG and drops `initial`-based memory/random init blocks for SRAM models (e.g., `mem_31x16`). This yields different JTAG TDO fallback values and different IOPMP table contents at t=0, which is consistent with the instruction-count mismatch (3 vs 2) while both runs stall at PC 0.

## Log evidence
- Ref run stops with `instrCnt = 3` at PC 0. `build/logs/xs/xs_ref_20260214_220725.log:9` and `build/logs/xs/xs_ref_20260214_220725.log:10`.
- Wolf run stops with `instrCnt = 2` at PC 0. `build/logs/xs/xs_wolf_20260214_220725.log:9` and `build/logs/xs/xs_wolf_20260214_220725.log:10`.
- Wolf log also shows a broken format string in the commit SHA line, implying some system-task formatting or string handling differences: `build/logs/xs/xs_wolf_20260214_220725.log:4`.

## FST evidence
Command:
```
python3 tools/fst_diff_tool.py --fst-a build/logs/xs/xs_ref_20260214_220725.fst --fst-b build/logs/xs/xs_wolf_20260214_220725.fst --top 5 --format table
```
Earliest diffs at t=0 include:
- `TOP.SimTop.cpu.jtag.random_bits` (ref non-zero, wolf zero)
- `TOP.SimTop.cpu.l_simMMIO.iopmp.iopmp_checker.ctrl.io_mdcfg_j_indx`
- `TOP.SimTop.cpu.l_simMMIO.iopmp.iopmp_checker.entry_table.entry_addr.io_a_rdata`
- `TOP.SimTop.cpu.l_simMMIO.iopmp.iopmp_checker.entry_table.entry_addr.mem_ext.R1_data`
- `TOP.SimTop.cpu.l_simMMIO.iopmp.iopmp_checker.entry_table.entry_addrh.io_a_rdata`

## Source vs emit comparison
### SimJTAG random bits init
- Original SimJTAG declares `random_bits` with an initializer: `tests/data/xiangshan/difftest/src/test/vsrc/common/SimJTAG.v:50`.
- Wolf emit declares `random_bits` as an undriven wire, with no initializer or assignment: `build/xs/wolf/wolf_emit/wolf_emit.sv:62328`.
- This changes `__jtag_TDO` fallback behavior at time 0, matching the diff in `TOP.SimTop.cpu.jtag.random_bits`.

### IOPMP table memory init
- Ref SRAM model includes `initial`-block randomization for memory and reg init under `ENABLE_INITIAL_MEM_` / `RANDOMIZE_MEM_INIT`: `build/xs/rtl/rtl/mem_31x16.sv:92`.
- Wolf emit memory model has no `initial` block at all: `build/xs/wolf/wolf_emit/wolf_emit.sv:1366031`.
- The earliest diffs on `iopmp_checker` table read paths (`io_mdcfg_j_indx`, `entry_addr.*`) are consistent with missing memory initialization.

## Root cause hypothesis
The wolf emitter is dropping (1) variable initialization at declaration time and (2) `initial`-block memory/random initialization. That yields deterministic zero/unknown values where the ref design expects randomized or initialized values, causing an immediate divergence at t=0. The instruction-count mismatch (3 vs 2) is a downstream symptom of this early divergence while both runs remain stuck at PC 0.

## Fix direction
- Preserve variable initializers (e.g., `logic [31:0] random_bits = $random;`) by lowering them into an `initial` block or equivalent emitted construct.
- Preserve `initial` blocks that randomize registers/memories under `ENABLE_INITIAL_*` macros, especially for `mem_*` models used by IOPMP tables.
- Recheck system-task formatting in wolf logs (e.g., `$display` with format specifiers) since the log shows broken `%d/%h` formatting; this may be a separate emit issue.
