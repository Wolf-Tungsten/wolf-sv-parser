# XS wave diff report (2026-02-17 run 20260217_223427)

## Executive summary
- Earliest divergence appears at cycle 8298 (time 16596) on `core.frontend.inner_ifu.io_toIBuffer_bits_instrs_*` (instruction words) in the wolf wave.
- The IFU inputs from Ftq, ICache, Uncache, and ready handshakes (`inner_ifu.io_fromFtq_*`, `inner_ifu.io_fromICache_*`, `inner_ifu.io_fromUncache_*`, `inner_ifu.io_toUncache_req_ready`, `inner_ifu.io_toIBuffer_ready`) show **no diffs** over the same ROI when compared with `--ignore-x`.
- The divergence propagates downstream into `inner_ibuffer.io_out_*` and then `frontend.io_backend_cfVec_*`.
- Conclusion: the **Ifu** module (instance `core.frontend.inner_ifu`) is the first block where **inputs are the same but outputs differ** (under `--ignore-x`), so it is the first *internal* divergence point.
- New finding (narrow window, no `--ignore-x`): `inner_ifu.io_fromICache_fetchResp_bits_data` diverges **earlier** (cycle 8296 / time 16592), and then is latched into `s2_rawFirstDataDup_*` (cycle 8297). This points to an **IFU-external root cause**, likely in the ICache/fetchResp path.

## Log evidence
- Ref log: `build/logs/xs/xs_ref_20260217_223427.log` (Seed=0, Guest cycle spent: 50005)
- Wolf log: `build/logs/xs/xs_wolf_20260217_223427.log` (Seed=0, Guest cycle spent: 8254)

## FST evidence (commands + results)

### IFU output divergence (earliest)
Command:
```bash
python3 tools/fst_diff_tool.py \
  --fst-a build/logs/xs/xs_ref_20260217_223427.fst \
  --fst-b build/logs/xs/xs_wolf_20260217_223427.fst \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_toIBuffer_*" \
  --clk TOP.SimTop.clock --format table --ignore-x --strip-width \
  --max-signals 200 --max-diffs 10 2>/tmp/fst_diff_err.txt
```
Key output (first diffs):
```
TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_toIBuffer_bits_instrs_10
  diverge_time: 16596  cycle_a: 8298  cycle_b: 8298
  value_a: 00000000000000000000010110010011
  value_b: 00000000000000000000000110010011

TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_toIBuffer_bits_instrs_11
  diverge_time: 16596  cycle_a: 8298  cycle_b: 8298
  value_a: 00000000000000000000011000010011
  value_b: 00000000000000000000001000010011
```

### IFU input comparison (no diff)
Command (Ftq inputs):
```bash
python3 tools/fst_diff_tool.py \
  --fst-a build/logs/xs/xs_ref_20260217_223427.fst \
  --fst-b build/logs/xs/xs_wolf_20260217_223427.fst \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_fromFtq_*" \
  --clk TOP.SimTop.clock --format table --ignore-x --strip-width \
  --max-signals 200 --max-diffs 5 2>/tmp/fst_diff_err.txt
```
Output:
```
ROI t=[0, 16607]  common=930335  compared=19  seeds=0  filtered=0  clk=TOP.SimTop.clock edge=rising cycle_base=1
no diff found
```

Command (ICache inputs):
```bash
python3 tools/fst_diff_tool.py \
  --fst-a build/logs/xs/xs_ref_20260217_223427.fst \
  --fst-b build/logs/xs/xs_wolf_20260217_223427.fst \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_fromICache_*" \
  --clk TOP.SimTop.clock --format table --ignore-x --strip-width \
  --max-signals 200 --max-diffs 5 2>/tmp/fst_diff_err.txt
```
Output:
```
ROI t=[0, 16607]  common=930335  compared=19  seeds=0  filtered=0  clk=TOP.SimTop.clock edge=rising cycle_base=1
no diff found
```

### Narrow-window confirmation (IFU input diverges earlier, not X/Z)
Command (ICache fetchResp data, no `--ignore-x`):
```bash
python3 tools/fst_diff_tool.py \
  --fst-a build/logs/xs/xs_ref_20260217_223427.fst \
  --fst-b build/logs/xs/xs_wolf_20260217_223427.fst \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_fromICache_fetchResp_bits_data" \
  --t0 16590 --t1 16600 --clk TOP.SimTop.clock --format table --strip-width \
  --max-diffs 5 2>/tmp/fst_diff_err.txt
```
Output (first diff):
```
TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_fromICache_fetchResp_bits_data
  diverge_time: 16592  cycle_a: 8296  cycle_b: 8296
  value_a: ...
  value_b: ...
```
This confirms the earliest divergence is at the IFU input (ICache fetch response), before `s2_rawFirstDataDup_*` and before `io_toIBuffer_*`.

Command (Uncache inputs + ready handshakes):
```bash
python3 tools/fst_diff_tool.py \
  --fst-a build/logs/xs/xs_ref_20260217_223427.fst \
  --fst-b build/logs/xs/xs_wolf_20260217_223427.fst \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_fromUncache_*" \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_toUncache_req_ready" \
  --signal "TOP.SimTop.cpu.l_soc.core_with_l2.core.frontend.inner_ifu.io_toIBuffer_ready" \
  --clk TOP.SimTop.clock --format table --ignore-x --strip-width \
  --max-signals 200 --max-diffs 5 2>/tmp/fst_diff_err.txt
```
Output:
```
ROI t=[0, 16607]  common=930335  compared=45  seeds=0  filtered=0  clk=TOP.SimTop.clock edge=rising cycle_base=1
no diff found
```

### Downstream propagation (IBuffer / frontend output)
The IFU output divergence propagates to:
- `core.frontend.inner_ibuffer.io_out_*`
- `core.frontend.io_backend_cfVec_*`

## Source/emit mapping
- Ref module definition: `build/xs/rtl/rtl/Ifu.sv`
- IFU instance and IBuffer hookup: `build/xs/rtl/rtl/Frontend.sv`
- Wolf emit IFU instance: `build/xs/wolf/wolf_emit/wolf_emit.sv`

Key connection chain (ref RTL):
- `Ifu io_toIBuffer_bits_*` → `_inner_ifu_io_toIBuffer_bits_*` → `inner_ibuffer.io_in_bits_*` → `inner_ibuffer.io_out_*` → `frontend.io_backend_cfVec_*`.

## Likely root cause direction
Given the narrow-window diff shows `io_fromICache_fetchResp_bits_data` diverging earlier, the root cause is likely **outside IFU**, in the ICache/fetchResp generation path:
- Trace `_inner_icache_io_toIfu_fetchResp_bits_data` upstream in ref RTL and wolf emit.
- Look for width/packing, slicing, or latency mismatches in ICache output.

## ICache dataflow (ref, high level)
Based on `build/xs/rtl/rtl/ICache.sv`:
- FTQ fetch requests drive `ICacheMainPipe` (`io_fromFtq_fetchReq_*` → `mainPipe.io_req_*`).
- `ICacheMainPipe` issues `ICacheDataArray` reads (data banks) and consumes `ICacheWayLookup` outputs (waymask/pTag/maybeRvcMap/meta codes).
- On miss, `ICacheMissUnit` refills via memory and writes `metaArray` + `dataArray`.
- `ICachePrefetchPipe` drives I-TLB/PMP/meta reads and can update `wayLookup`.
- Final output `io_toIfu_fetchResp_bits_data` is directly sourced from `mainPipe.io_resp_bits_data`.

## New hypothesis from dataflow
Since `io_fromICache_fetchResp_bits_data` diverges before IFU, likely candidates are inside ICache:
- `ICacheMainPipe` response selection/packing (waymask selection, hit vs miss mux).
- `ICacheDataArray` contents (writeback from miss unit or incorrect bank/offset).
- `ICacheMissUnit` refill data assembly from memory.
- `ICacheWayLookup` / `metaArray` metadata mismatches (wrong waymask / tag).

## ICache wave trace (step-by-step)
Wave diff along the fetchResp data chain (ROI t=[16580,16600], `--ignore-x`):
- `inner_icache.io_toIfu_fetchResp_bits_data` diverges at **time 16592 / cycle 8296**.
- `inner_icache.mainPipe.io_resp_bits_data` diverges at **time 16592 / cycle 8296** (same as output).
- `inner_icache.mainPipe.io_missResp_bits_data` diverges earlier at **time 16590 / cycle 8295**.
- `inner_icache.missUnit.io_memGrant_bits_data` diverges earlier at **time 16580 / cycle 8290**.
- `inner_icache.auto_client_out_d_bits_data` diverges at **time 16580 / cycle 8290** and matches the missUnit input.

Validity checks (both ref & wolf):
- `inner_icache.missUnit.io_memGrant_valid` is **1** at t=16580/16582/16588/16590/16592.
- `inner_icache.mainPipe.io_missResp_valid` and `io_resp_valid` are **1** at t=16592.

Conclusion: the **earliest meaningful divergence** in the ICache chain is at the **memory grant interface** (`auto_client_out_d_bits_data`), which is **upstream of ICache**. The later differences in `mainPipe` and `io_toIfu_fetchResp_bits_data` are downstream propagation.

## Notes on noise handling
- All diff runs used `--ignore-x` to avoid X/Z or randomized init noise.
- Divergent signals are instruction words and FTQ metadata, not random registers.
