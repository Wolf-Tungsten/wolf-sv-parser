# XS Waveform Diff Diagnosis (2026-02-14 15:55:22)

## Executive Summary
- Ref reaches cycle limit; wolf still aborts at cycle 0 with `MEFreeList.sv:2032` assertion.
- With `--emit-trace-underscore` enabled, the FST now contains `wd___expr_*` aliases, allowing direct inspection of the assertion update condition.
- The update condition (`__expr_6`) is **1 at t=2**, while all architectural pointers/RAT signals remain reset-consistent.
- Root cause is a **width/bit-select bug** in the emitted expression chain: the 9-bit cast (`9'(...)`) is effectively reduced to **LSB-only** via `[0]` selects, collapsing the sum to 0 and making the assertion fire.

## Log Evidence
- Wolf aborts at cycle 0 with `MEFreeList.sv:2032` assertion: `build/logs/xs/xs_wolf_20260214_155522.log`.
- Ref runs to cycle limit: `build/logs/xs/xs_ref_20260214_155522.log`.

## FST Evidence (fst_diff_tool)
Command:
```
/usr/bin/python3 tools/fst_diff_tool.py \
  --fst-a build/logs/xs/xs_ref_20260214_155522.fst \
  --fst-b build/logs/xs/xs_wolf_20260214_155522.fst \
  --top 10 --format table
```
Earliest diffs are still at t=0 (e.g., `SimJTAG.random_bits`, IOPMP tables), consistent with init divergence. These are unchanged from 2026-02-13 and are not the immediate cause of the MEFreeList assertion.

## updateCond from Trace Aliases (wolf FST)
With `--emit-trace-underscore`, the FST contains `wd___expr_*` aliases inside `intFreeList`. Snapshot at t=0 and t=2:

```
/usr/bin/python3 tools/fst_roi/fst_roi.py \
  --fst build/logs/xs/xs_wolf_20260214_155522.fst \
  --signals-file /tmp/xs_updatecond_exprs.txt \
  --t0 0 --t1 0 --format table --match-strip-width --strip-width
```
- t=0: `wd___expr_0=0`, `wd___expr_5=0`, `wd___expr_6=0`

```
/usr/bin/python3 tools/fst_roi/fst_roi.py \
  --fst build/logs/xs/xs_wolf_20260214_155522.fst \
  --signals-file /tmp/xs_updatecond_exprs.txt \
  --t0 2 --t1 2 --format table --match-strip-width --strip-width
```
- t=2: `wd___expr_0=1`, `wd___expr_5=1`, `wd___expr_6=1`

Since `__expr_6 = __expr_5 && (|__const_0)` and `__expr_5 = _GEN_45 & ~reset`, this shows the update condition is **true at t=2** even though reset is deasserted and pointers are in reset-consistent values.

## Assertion Chain: Width Bug Evidence
From wolf emit (`build/xs/wolf/wolf_emit/wolf_emit.sv`):
```
assign __expr_8446 = {1'b0, __expr_8445};
assign __expr_8447 = __expr_8446[0];
...
assign __expr_8456 = {3'b0, __expr_8455};
assign __expr_8457 = __expr_8456[0];
assign __expr_8458 = __expr_8447 + __expr_8457;
assign __expr_8460 = {1'b0, __expr_8458};
assign __expr_8461 = __expr_8460 != 9'd224;
assign _GEN_45 = __expr_8461;
```
Line refs: `build/xs/wolf/wolf_emit/wolf_emit.sv:6406888` to `build/xs/wolf/wolf_emit/wolf_emit.sv:6406926`.

FST snapshot at t=2 (wolf):
```
/usr/bin/python3 tools/fst_roi/fst_roi.py \
  --fst build/logs/xs/xs_wolf_20260214_155522.fst \
  --signals-file /tmp/xs_expr_chain.txt \
  --t0 2 --t1 2 --format table --match-strip-width --strip-width
```
Observed:
- `wd___expr_8447 = 1` (LSB of distanceBetween)
- `wd___expr_8457 = 1` (LSB of unique-count sum)
- `wd___expr_8458 = 0` (1-bit add)
- `wd___expr_8460 = 0`
- `wd___expr_8461 = 1` â†’ `_GEN_45 = 1`

This confirms the 9-bit cast in the source (`9'(...)`) is being effectively **reduced to LSB** in wolf emit. The resulting sum is 0, so `_GEN_45` is true and the assertion fires.

## Reference RTL (correct intent)
From `build/xs/rtl/rtl/MEFreeList.sv:2010-2018`:
```
_GEN_45 = 9'({1'h0, distanceBetween(...)} + {3'h0, 6'(...)} ) != 9'hE0;
```
No bit-select is applied; the full 9-bit sum should be compared against 224.

## Conclusion
The immediate cause of the MEFreeList assertion in wolf is a **width/resize lowering bug**:
- The casted 9-bit sum is truncated to 1 bit via `[0]` selects (`__expr_8446[0]`, `__expr_8456[0]`).
- This collapses the sum to 0, so `_GEN_45` becomes 1 at t=2 and the assert triggers.

## Suggested Fix Direction
Investigate cast/resize lowering in convert/emit:
- The `N'(...)` sized cast should preserve **N-bit** width, not LSB.
- Look for where sized casts are lowered to bit-selects (likely in convert or emit expression sizing).
- Add a unit test in emit/convert to ensure sized-cast expressions preserve width.
