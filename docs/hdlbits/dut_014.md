# dut_014 宽度问题修复记录

## 问题
- Verilator 对 `a || b` 报 WIDTHTRUNC：逻辑运算符期望单比特输入，但 `a`/`b` 是 3 位向量，直接送入逻辑或会被截断。

## 解决思路
- 在 elaboration 阶段显式插入真值规约：对逻辑 AND/OR/NOT 的多比特操作数先生成 `kReduceOr`（等价于 `(|operand)`）得到 1 bit 真值，再进行逻辑运算。这样 GRH 已满足位宽要求，emit 无需再补救，Verilator 不会再报截断。

## 运行命令与输出
```bash
make run_hdlbits_test DUT=014
```
```
build/bin/wolf-sv-parser --emit-sv --emit-json -o build/hdlbits/014/dut_014.v tests/data/hdlbits/dut/dut_014.v
Top level design units:
    top_module

=== GRH JSON ===
{
  "graphs": [
    {
      "symbol": "top_module",
      "vals": [
        {"sym": "a", "w": 3, "sgn": false, "in": true, "out": false, "users": [{"op": "bin_0_0", "idx": 0}, {"op": "logic_truth_1_0", "idx": 0}, {"op": "range_slice_3_0", "idx": 0}]},
        {"sym": "b", "w": 3, "sgn": false, "in": true, "out": false, "users": [{"op": "bin_0_0", "idx": 1}, {"op": "logic_truth_1_1", "idx": 0}, {"op": "range_slice_2_0", "idx": 0}]},
        {"sym": "out_or_bitwise", "w": 3, "sgn": false, "in": false, "out": true, "def": "out_or_bitwise_assign_0", "users": []},
        {"sym": "out_or_logical", "w": 1, "sgn": false, "in": false, "out": true, "def": "out_or_logical_assign_1", "users": []},
        {"sym": "out_not", "w": 6, "sgn": false, "in": false, "out": true, "def": "out_not_assign_4", "users": []},
        {"sym": "bin_0_0", "w": 3, "sgn": false, "in": false, "out": false, "def": "bin_0_0", "users": [{"op": "out_or_bitwise_assign_0", "idx": 0}]},
        {"sym": "logic_truth_1_0", "w": 1, "sgn": false, "in": false, "out": false, "def": "logic_truth_1_0", "users": [{"op": "bin_1_2", "idx": 0}]},
        {"sym": "logic_truth_1_1", "w": 1, "sgn": false, "in": false, "out": false, "def": "logic_truth_1_1", "users": [{"op": "bin_1_2", "idx": 1}]},
        {"sym": "bin_1_2", "w": 1, "sgn": false, "in": false, "out": false, "def": "bin_1_2", "users": [{"op": "out_or_logical_assign_1", "idx": 0}]},
        {"sym": "range_slice_2_0", "w": 3, "sgn": false, "in": false, "out": false, "def": "range_slice_2_0", "users": [{"op": "not_2_1", "idx": 0}]},
        {"sym": "not_2_1", "w": 3, "sgn": false, "in": false, "out": false, "def": "not_2_1", "users": [{"op": "out_not_concat_2", "idx": 0}]},
        {"sym": "range_slice_3_0", "w": 3, "sgn": false, "in": false, "out": false, "def": "range_slice_3_0", "users": [{"op": "not_3_1", "idx": 0}]},
        {"sym": "not_3_1", "w": 3, "sgn": false, "in": false, "out": false, "def": "not_3_1", "users": [{"op": "out_not_concat_2", "idx": 1}]},
        {"sym": "out_not_concat_3", "w": 6, "sgn": false, "in": false, "out": false, "def": "out_not_concat_2", "users": [{"op": "out_not_assign_4", "idx": 0}]}
      ],
      "ports": {
        "in": [
          {"name": "a", "val": "a"},
          {"name": "b", "val": "b"}
        ],
        "out": [
          {"name": "out_not", "val": "out_not"},
          {"name": "out_or_bitwise", "val": "out_or_bitwise"},
          {"name": "out_or_logical", "val": "out_or_logical"}
        ]
      },
      "ops": [
        {"sym": "bin_0_0", "kind": "kOr", "in": ["a", "b"], "out": ["bin_0_0"]},
        {"sym": "logic_truth_1_0", "kind": "kReduceOr", "in": ["a"], "out": ["logic_truth_1_0"]},
        {"sym": "logic_truth_1_1", "kind": "kReduceOr", "in": ["b"], "out": ["logic_truth_1_1"]},
        {"sym": "bin_1_2", "kind": "kLogicOr", "in": ["logic_truth_1_0", "logic_truth_1_1"], "out": ["bin_1_2"]},
        {"sym": "range_slice_2_0", "kind": "kSliceStatic", "in": ["b"], "out": ["range_slice_2_0"], "attrs": {"sliceEnd": {"k": "int", "v": 2}, "sliceStart": {"k": "int", "v": 0}}},
        {"sym": "not_2_1", "kind": "kNot", "in": ["range_slice_2_0"], "out": ["not_2_1"]},
        {"sym": "range_slice_3_0", "kind": "kSliceStatic", "in": ["a"], "out": ["range_slice_3_0"], "attrs": {"sliceEnd": {"k": "int", "v": 2}, "sliceStart": {"k": "int", "v": 0}}},
        {"sym": "not_3_1", "kind": "kNot", "in": ["range_slice_3_0"], "out": ["not_3_1"]},
        {"sym": "out_or_bitwise_assign_0", "kind": "kAssign", "in": ["bin_0_0"], "out": ["out_or_bitwise"]},
        {"sym": "out_or_logical_assign_1", "kind": "kAssign", "in": ["bin_1_2"], "out": ["out_or_logical"]},
        {"sym": "out_not_concat_2", "kind": "kConcat", "in": ["not_2_1", "not_3_1"], "out": ["out_not_concat_3"]},
        {"sym": "out_not_assign_4", "kind": "kAssign", "in": ["out_not_concat_3"], "out": ["out_not"]}
      ]
    }
  ],
  "tops": [
    "top_module"
  ]
}
[emit-sv] Wrote SystemVerilog to /workspace/wolf-sv-parser/build/hdlbits/014/dut_014.v
Build succeeded: 0 errors, 0 warnings
verilator -Wall -Wno-DECLFILENAME -Wno-UNUSEDSIGNAL -Wno-UNDRIVEN -Wno-SYNCASYNCNET --cc build/hdlbits/014/dut_014.v --exe tests/data/hdlbits/tb/tb_014.cpp \
	--top-module top_module --prefix Vdut_014 -Mdir build/hdlbits/014 -o sim_014
- V e r i l a t i o n   R e p o r t: Verilator 5.041 devel rev v5.040-298-gcefcf836f
- Verilator: Built from 0.022 MB sources in 2 modules, into 0.026 MB in 7 C++ files needing 0.000 MB
- Verilator: Walltime 0.013 s (elab=0.001, cvt=0.005, bld=0.000); cpu 0.013 s on 1 threads; alloced 31.426 MB
CCACHE_DISABLE=1 make -C build/hdlbits/014 -f Vdut_014.mk sim_014
make[1]: Entering directory '/workspace/wolf-sv-parser/build/hdlbits/014'
ccache g++  -I.  -MMD -I/download/verilator/include -I/download/verilator/include/vltstd -DVERILATOR=1 -DVM_COVERAGE=0 -DVM_SC=0 -DVM_TIMING=0 -DVM_TRACE=0 -DVM_TRACE_FST=0 -DVM_TRACE_VCD=0 -DVM_TRACE_SAIF=0 -faligned-new -fcf-protection=none -Wno-bool-operation -Wno-int-in-bool-context -Wno-shadow -Wno-sign-compare -Wno-subobject-linkage -Wno-tautological-compare -Wno-uninitialized -Wno-unused-but-set-parameter -Wno-unused-but-set-variable -Wno-unused-parameter -Wno-unused-variable      -Os  -c -o tb_014.o ../../../tests/data/hdlbits/tb/tb_014.cpp
ccache g++ -Os  -I.  -MMD -I/download/verilator/include -I/download/verilator/include/vltstd -DVERILATOR=1 -DVM_COVERAGE=0 -DVM_SC=0 -DVM_TIMING=0 -DVM_TRACE=0 -DVM_TRACE_FST=0 -DVM_TRACE_VCD=0 -DVM_TRACE_SAIF=0 -faligned-new -fcf-protection=none -Wno-bool-operation -Wno-int-in-bool-context -Wno-shadow -Wno-sign-compare -Wno-subobject-linkage -Wno-tautological-compare -Wno-uninitialized -Wno-unused-but-set-parameter -Wno-unused-but-set-variable -Wno-unused-parameter -Wno-unused-variable      -c -o verilated.o /download/verilator/include/verilated.cpp
ccache g++ -Os  -I.  -MMD -I/download/verilator/include -I/download/verilator/include/vltstd -DVERILATOR=1 -DVM_COVERAGE=0 -DVM_SC=0 -DVM_TIMING=0 -DVM_TRACE=0 -DVM_TRACE_FST=0 -DVM_TRACE_VCD=0 -DVM_TRACE_SAIF=0 -faligned-new -fcf-protection=none -Wno-bool-operation -Wno-int-in-bool-context -Wno-shadow -Wno-sign-compare -Wno-subobject-linkage -Wno-tautological-compare -Wno-uninitialized -Wno-unused-but-set-parameter -Wno-unused-but-set-variable -Wno-unused-parameter -Wno-unused-variable      -c -o verilated_threads.o /download/verilator/include/verilated_threads.cpp
python3 /download/verilator/bin/verilator_includer -DVL_INCLUDE_OPT=include Vdut_014.cpp Vdut_014___024root__DepSet_h2ee78c2a__0.cpp Vdut_014___024root__DepSet_h606b3065__0.cpp Vdut_014___024root__Slow.cpp Vdut_014___024root__DepSet_h2ee78c2a__0__Slow.cpp Vdut_014___024root__DepSet_h606b3065__0__Slow.cpp Vdut_014__Syms.cpp > Vdut_014__ALL.cpp
ccache g++ -Os  -I.  -MMD -I/download/verilator/include -I/download/verilator/include/vltstd -DVERILATOR=1 -DVM_COVERAGE=0 -DVM_SC=0 -DVM_TIMING=0 -DVM_TRACE=0 -DVM_TRACE_FST=0 -DVM_TRACE_VCD=0 -DVM_TRACE_SAIF=0 -faligned-new -fcf-protection=none -Wno-bool-operation -Wno-int-in-bool-context -Wno-shadow -Wno-sign-compare -Wno-subobject-linkage -Wno-tautological-compare -Wno-uninitialized -Wno-unused-but-set-parameter -Wno-unused-but-set-variable -Wno-unused-parameter -Wno-unused-variable      -c -o Vdut_014__ALL.o Vdut_014__ALL.cpp
echo "" > Vdut_014__ALL.verilator_deplist.tmp
g++    tb_014.o verilated.o verilated_threads.o Vdut_014__ALL.a    -pthread -lpthread -latomic   -o sim_014
rm Vdut_014__ALL.verilator_deplist.tmp
make[1]: Leaving directory '/workspace/wolf-sv-parser/build/hdlbits/014'
[RUN] ./build/hdlbits/014/sim_014
[TB] dut_014 passed: bitwise/logical or and inversion checks
```
