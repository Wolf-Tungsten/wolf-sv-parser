# wolf-sv-compiler 总览

本文档面向项目贡献者与集成方，概述 wolf-sv-compiler 的定位、输入输出契约、核心处理流程以及配套支撑能力，作为后续设计文档与实现的入口。

## 项目目标

wolf-sv-compiler 致力于将高层次行为化的 RTL（基于 Verilog-2005/SystemVerilog 子集）转换为结构化的 GRH 表示，再由 GRH 表示输出成结构化的 verilog 网表，支持可配置的逻辑变换及插件扩展能力，服务于后续仿真、综合、形式验证与定制分析流程。

## 输入契约

- **语言范围**：遵循 `slang` master 分支所支持的 Verilog-2005 与 SystemVerilog 子集，默认输入语法正确。
- **编译配置**：兼容 `slang` CLI 的关键开关（例如 `--top`、宏定义、`include` 路径等），统一由命令行参数传入，同时预留 API/配置文件对接能力。
- **多文件工程**：支持工程级文件列表。模块体为空但接口完整的模块视为黑盒，可直接透传，无需额外标注。
- **约束输入**：当前阶段仅处理纯 RTL，不接收 SDC、时钟/复位约束等额外数据。

## 输出契约

- **结构化网表**：输出为纯组合/时序结构的 Structural Verilog，寄存器、存储器等映射为标准原语实例。
- **层级保持**：保留来源设计的模块层次，黑盒模块直接复用输入端口与参数定义。
- **文件布局**：默认生成单文件 `out.v`，支持通过配置拆分多文件（如按模块层级分组）并自定义输出目录。
- **格式风格**：使用内部生成器的默认格式，不强制额外的格式化工具。
- **元数据产出**：网表生成时同步导出 JSON 文件，记录节点/边统计、各 Pass 的变换摘要及告警信息，为后续工具链提供结构化数据接口。

## 处理流程

### 1. 解析阶段

- 嵌入 `slang` C++ API 对源文件进行解析，获得抽象语法树（AST）与语义信息。
- 在该阶段完成语法、语义诊断，并保存宏展开、层级上下文，作为后续步骤的输入条件。

### 2. 图构建阶段

- 基于 `slang` AST 构建内部 GRH 表示，节点抽象算子、触发器、存储器与模块实例，边表示信号依赖。
- 图结构保留模块层级，通过实例边连接子图，支持局部优化与层次化回写。
- 同步记录位宽、时序域、驱动关系等元信息，作为变换阶段的静态约束。

### 3. 变换阶段

- 提供内置的拓扑安全 Pass（常量折叠、冗余逻辑消除、寄存器合并等），执行顺序可配置。
- **插件框架设计草案**：
  - 插件以共享库或静态注册形式加载，统一实现 `Pass::run(GraphContext&)` 接口。
  - 通过 YAML/JSON 配置描述 Pass 管道，包括执行顺序、参数与启用条件；插件可声明依赖与互斥关系。
  - 生命周期钩子覆盖 `initialize`（资源准备）、`run`（核心逻辑）、`finalize`（资源回收与统计上报），并与日志/元数据系统对接。
  - 提供上下文访问接口（如信号查询、拓扑遍历、统计写入），保障插件的一致性与安全性。

### 4. 回写阶段

- 遍历变换后的 DAG，将节点映射回 Structural Verilog，保持模块边界与端口顺序。
- 支持按模块层级、文件大小或用户自定义策略拆分输出文件；黑盒模块直接引用原始定义。
- 输出阶段同步写出元数据 JSON：包括节点/边统计、各 Pass 的变更摘要、警告列表以及输出文件映射表，供后续工具消费。

## 支撑能力

- **日志体系**：提供 `error`/`warn`/`info`/`debug` 多级日志，默认输出到 stdout，并支持将关键日志落盘。日志消息包含阶段标识、Pass 名称与上下文哈希，便于问题追踪；当前以文本格式输出。
- **测试策略**：
  - 单元测试覆盖解析封装、图构建、核心 Pass 与回写模块。
  - 端到端测试确保代表性 RTL 在输入到网表的转换链路中保持功能等价，并验证黑盒透传。
  - 筛选并维护基于开源 RTL 的基准集合，结合黄金网表或仿真结果进行回归测试；当前尚无官方参考测试集，需要项目内自建。
- **配置与接口**：统一的命令行解析与配置文件机制，供工具链集成；插件框架共享日志、元数据与资源管理接口，降低扩展成本。

## 后续工作重点

1. 细化插件框架与日志规范的设计文档，明确接口与扩展约束。
2. 基于项目需求敲定元数据 JSON schema、命名规范与兼容策略。
3. 建立基准测试集与自动化验证流程，明确授权、更新频率与验收标准。

